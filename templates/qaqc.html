{% extends "layout.html" %}
{% block body %}

<div class="row"><div class="col-md-6 col-md-offset-3">
  <form id="qaqc">
    <div class="col-md-8">
      <select placeholder="Choose a site" id="dsite" name="site">
        <option value="">Choose a site</option>
        {% for s in sites %}
        <option value="{{s}}">{{s}}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <button name="qaqcsite" class="btn btn-primary btn-block">Select</button>
    </div>
  </form>
</div></div>
<br>

<div class="row" id="flagging">

<div class="row text-center">
  <div class="col-md-12">
    <div class="panel panel-default">
      <div class="panel-body">
        <div class="form-inline">
        Show local night-time: <input type="checkbox" id="shownight" value="yes" checked> &nbsp;
        <!-- Aggregation: <select class="form-control" id="timescale" name="timescale">
          <option value="15m" selected>15 minutes (default)</option>
          <option value="1h">1 hour</option>
          <option value="1d">1 day</option></select> &nbsp; -->
        Fill down marking brush: <input type="checkbox" id="fillbrush" value="yes"> &nbsp;
        Backfill area variable: <select class="form-control" id="backgraphlist" name="backgraphlist"></select>
        <br>
        <button class="btn btn-danger" type="button" id="addna">Set NA values</button>
        <button class="btn btn-primary" type="button" id="zoomin">Zoom in to selected region</button>
        <button class="btn btn-link" type="button" id="zoomreset">Reset zoom</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <div class="panel panel-default">
      <div class="panel-body">
        <select id="flags" placeholder="Choose (or enter) a flag ID" name="flagID">
          <option value="">Choose (or enter) a flag ID</option>
          {% for f in flags %}
          <option value="{{f}}">{{f}}</option>
          {% endfor %}
        </select>
        <input type="text" name="fcomment" class="form-control" placeholder="Add comments (optional)">
        <button class="btn btn-warning btn-block" type="button" id="addflag">Flag selected</button>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="panel panel-default">
      <div class="panel-body">
        <select id="tags" placeholder="Choose (or enter) a tag ID" name="tagID">
          <option value="">Choose (or enter) a tag ID</option>
          {% for t in tags %}
          <option value="{{f}}">{{t}}</option>
          {% endfor %}
        </select>
        <input type="text" name="fcomment" class="form-control" placeholder="Add comments (optional)">
        <button class="btn btn-info btn-block" type="button" id="addtag">Tag selected</button>
      </div>
    </div>
  </div>
</div>
<br>
<div class="row text-center">

</div>

</div>



<div class="row" id="graphs"></div>


<script src="static/js/graphs.js"></script>
<script>
$('#dsite').selectize({
    delimiter: ',',
    persist: false,
    create: function(input) { return {value: input,text: input} }
});

$('#flags').selectize({
    delimiter: ',',
    persist: false,
    create: function(input) { return {value: input,text: input} }
});

$('#tags').selectize({
    delimiter: ',',
    persist: false,
    create: function(input) { return {value: input,text: input} }
});


$(function(){
  $("button[name=qaqcsite]").click(function(){
    var dat = {}
    dat['site'] = $('select[name=site]').val();
    $.ajax({
      type: 'POST',
      url:'/_getqaqc',
      data: JSON.stringify(dat),
      contentType: 'application/json;charset=UTF-8',
      success: function(response){
        $("#graphs").empty();
        data = JSON.parse(response.dat);
        variables = response.variables;
        sundat = JSON.parse(response.sunriseset);
        sundat.forEach(function(d){
          d.rise = parseDate(d.rise);
          d.set = parseDate(d.set);
        });
        flags = JSON.parse(response.flagdat);
        Plots(variables, data, flags, "qaqc");
        if($("#shownight").is(":checked")) { Sunlight(variables, sundat) };
        $('#flagging').show();
        $('#backgraphlist')
            .find('option')
            .remove()
            .end()
            .append('<option value="None" selected>None</option>');
        for (var i = 0; i < response.variables.length; ++i) {
            $('#backgraphlist').append('<option value="'+response.variables[i]+'">'+response.variables[i]+'</option>');
        }
      },
      error: function(error){
        console.log(error);
      }
    });
    return false;
  })
});

$(function(){
  $("#zoomin").click(function(){
    redrawPoints(zoom_in = true)
  });
})

$(function(){
  $("#zoomreset").click(function(){
    redrawPoints(zoom_in = true)
  });
})


function alertbox(alrt,msg){
  return '<div class="alert alert-dismissible alert-'+alrt+'">\
    <button class="close" data-dismiss="alert" aria-label="close">&times;</button>\
    '+msg+'</div>'
}


$(function(){
  $("#addna").click(function(){
    s = d3.brushSelection(d3.select("#"+selectedBrush).node())
    dat = {}
    dat['site'] = $('select[name=site]').val();
    dat['startDate'] = x.invert(s[0]);
    dat['endDate'] = x.invert(s[1]);
    dat['var'] = selectedBrush;
    $.ajax({
      type: 'POST',
      url:'/_addna',
      data: JSON.stringify(dat),
      contentType: 'application/json;charset=UTF-8',
      success: function(response){
        console.log("success")
        $("#alerts").append(alertbox('success','Added NA values.'))
        datna = JSON.parse(response.dat);
        redrawPoints(zoom_in=false)
      },
      error: function(error){
        console.log(error);
      }
    });
    return false;
  });
})

$(function(){
  $("#addflag").click(function(){
    s = d3.brushSelection(d3.select("#"+selectedBrush).node())
    dat = {}
    dat['site'] = $('select[name=site]').val();
    dat['startDate'] = x.invert(s[0]);
    dat['endDate'] = x.invert(s[1]);
    if(brushdown){
      dat['var'] = variables;
      d3.selectAll("svg").selectAll(".selected").classed("highlighted", function(d) {
        is_brushed = dat['startDate'] <= d.date && d.date <= dat['endDate'];
        return is_brushed;
      });
    }else{
      dat['var'] = [selectedBrush];
      d3.select("."+selectedBrush).selectAll(".selected").classed("highlighted", function(d) {
        is_brushed = dat['startDate'] <= d.date && d.date <= dat['endDate'];
        return is_brushed;
      });
    }
    dat['flagid'] = $("select[name=flagID]").val();
    dat['comment'] = $("input[name=fcomment]").val();
    $.ajax({
      type: 'POST',
      url:'/_addflag',
      data: JSON.stringify(dat),
      contentType: 'application/json;charset=UTF-8',
      success: function(response){
        console.log("success")
        $("#alerts").append(alertbox('success','Added flag.'))
      },
      error: function(error){
        console.log(error);
      }
    });
    return false;
  })
});

$(function(){
  $("#addtag").click(function(){
    s = d3.brushSelection(d3.select("#"+selectedBrush).node())
    dat = {}
    dat['site'] = $('select[name=site]').val();
    dat['startDate'] = x.invert(s[0]);
    dat['endDate'] = x.invert(s[1]);
    dat['var'] = selectedBrush;
    dat['tagid'] = $("select[name=tagID]").val();
    dat['comment'] = $("input[name=fcomment]").val();
    d3.select("."+selectedBrush).selectAll(".selected").classed("highlighted", function(d) {
      is_brushed = dat['startDate'] <= d.date && d.date <= dat['endDate'];
      return is_brushed;
    });
    $.ajax({
      type: 'POST',
      url:'/_addtag',
      data: JSON.stringify(dat),
      contentType: 'application/json;charset=UTF-8',
      success: function(response){
        console.log("success")
        $("#alerts").append(alertbox('success','Added tag.'))
      },
      error: function(error){
        console.log(error);
      }
    });
    return false;
  })
});

$(function(){
  $('#fillbrush').change(function() {
    if($(this).is(":checked")) {
      brushdown = true;
    }else{
      brushdown = false;
    }
  });
})

</script>

{% endblock %}
